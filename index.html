<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ü–æ–∫–µ—Ä —Å –¥—Ä—É–∑—å—è–º–∏</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
:root {
  --green: #1a6b3c; --green-dark: #124d2c; --green-light: #2a9d5c;
  --gold: #f0c040; --bg: #0f2d1a; --card-bg: #163824; --card-border: #2d6040;
  --text: #e8f5ee; --text-muted: #8bb89a;
  --red: #e05050; --blue: #4090d0;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
html, body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100dvh; overscroll-behavior: none; }
body { padding-bottom: calc(16px + var(--safe-bottom)); }
h1 { text-align: center; padding: 16px 16px 6px; font-size: 1.6rem; color: var(--gold); letter-spacing: 1px; }
.subtitle { text-align: center; color: var(--text-muted); font-size: 0.82rem; margin-bottom: 16px; }
.section { max-width: 600px; margin: 0 auto 16px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 14px; padding: 16px; }
.section h2 { color: var(--gold); font-size: 1rem; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
label { display: block; font-size: 0.82rem; color: var(--text-muted); margin-bottom: 4px; }
input[type="text"], input[type="number"], input[type="password"] {
  width: 100%; background: #0f2d1a; border: 1px solid var(--card-border);
  border-radius: 8px; color: var(--text); padding: 11px 14px; font-size: 16px; outline: none; transition: border-color 0.2s;
}
input:focus { border-color: var(--gold); }
.row { display: flex; gap: 10px; margin-bottom: 12px; }
.row > div { flex: 1; }
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 12px 20px; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: transform 0.1s, filter 0.15s; min-height: 44px; }
.btn:active { transform: scale(0.96); filter: brightness(0.9); }
.btn-gold { background: var(--gold); color: #1a1a00; }
.btn-green { background: var(--green-light); color: white; }
.btn-red { background: var(--red); color: white; }
.btn-blue { background: var(--blue); color: white; }
.btn-sm { padding: 9px 13px; font-size: 0.82rem; min-height: 38px; }
.btn-full { width: 100%; }
.nav-tabs { display: flex; max-width: 600px; margin: 0 auto; background: var(--card-bg); border-bottom: 2px solid var(--card-border); position: sticky; top: 0; z-index: 100; }
.nav-tab { flex: 1; padding: 11px 4px; text-align: center; cursor: pointer; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; min-height: 44px; display: flex; align-items: center; justify-content: center; }
.nav-tab.active { color: var(--gold); border-bottom-color: var(--gold); }
.names-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
.name-input-wrap { position: relative; }
.name-input-wrap input { padding-right: 42px; }
.remove-btn { position: absolute; right: 0; top: 0; height: 100%; width: 42px; background: none; border: none; color: var(--red); cursor: pointer; font-size: 1.3rem; display: flex; align-items: center; justify-content: center; }
.page { display: none; }
.page.active { display: block; }
#page-auth.active { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100dvh; padding: 24px; }
.auth-box { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; padding: 32px 24px; width: 100%; max-width: 360px; text-align: center; }
.auth-box h2 { color: var(--gold); font-size: 1.3rem; margin-bottom: 8px; }
.auth-box p { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px; }
.auth-error { color: var(--red); font-size: 0.83rem; margin-top: 10px; min-height: 20px; }
.players-grid { display: flex; flex-direction: column; gap: 10px; max-width: 600px; margin: 0 auto 24px; padding: 0 12px; }
.player-card { background: var(--card-bg); border: 1.5px solid var(--card-border); border-radius: 12px; padding: 14px; transition: border-color 0.3s; }
.player-name { font-size: 1.05rem; font-weight: 700; color: var(--gold); margin-bottom: 8px; }
.player-chips-display { font-size: 0.9rem; color: var(--text-muted); line-height: 1.6; }
.player-chips-display span { color: var(--text); font-weight: 600; }
.player-actions { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
.player-actions input { flex: 1; }
.history-log { max-height: 90px; overflow-y: auto; margin-top: 8px; }
.history-item { font-size: 0.73rem; color: var(--text-muted); padding: 2px 0; border-bottom: 1px solid #1e4a2c; }
.result-table { width: 100%; border-collapse: collapse; margin-bottom: 16px; font-size: 0.88rem; }
.result-table th { background: var(--green-dark); color: var(--gold); padding: 9px 10px; text-align: left; font-size: 0.78rem; }
.result-table td { padding: 9px 10px; border-bottom: 1px solid var(--card-border); }
.result-table tr:last-child td { border: none; }
.pos { color: #60e080; font-weight: 700; }
.neg { color: var(--red); font-weight: 700; }
.zero { color: var(--text-muted); }
.transactions { list-style: none; }
.transactions li { background: #0f2d1a; border: 1px solid var(--card-border); border-radius: 8px; padding: 11px 13px; margin-bottom: 8px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.transactions li .arrow { color: var(--gold); }
.transactions li .amount { margin-left: auto; font-weight: 700; color: var(--gold); }
.settled { opacity: 0.4; text-decoration: line-through; }
.settle-btn { background: none; border: 1px solid var(--green-light); color: var(--green-light); border-radius: 6px; padding: 4px 9px; font-size: 0.75rem; cursor: pointer; min-height: 30px; }
.leader-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.leader-table th { background: var(--green-dark); color: var(--gold); padding: 9px 10px; text-align: left; font-size: 0.78rem; }
.leader-table td { padding: 9px 10px; border-bottom: 1px solid var(--card-border); }
.leader-table tr:last-child td { border: none; }
.rank-1 td:first-child { color: #ffd700; }
.rank-2 td:first-child { color: #c0c0c0; }
.rank-3 td:first-child { color: #cd7f32; }
.history-card { background: #0f2d1a; border: 1px solid var(--card-border); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
.history-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 10px; gap: 6px; }
.history-card-title { font-weight: 700; color: var(--gold); font-size: 0.95rem; }
.history-card-date { font-size: 0.75rem; color: var(--text-muted); }
.history-mini-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.history-mini-table th { color: var(--text-muted); padding: 4px 7px; border-bottom: 1px solid var(--card-border); }
.history-mini-table td { padding: 5px 7px; border-bottom: 1px solid #1a3a28; }
.history-mini-table tr:last-child td { border: none; }
.delete-game-btn { background: none; border: 1px solid #3a2020; color: var(--red); border-radius: 6px; padding: 4px 9px; font-size: 0.75rem; cursor: pointer; white-space: nowrap; }
.empty-state { text-align: center; color: var(--text-muted); padding: 36px 0; font-size: 0.92rem; }
.divider { height: 1px; background: var(--card-border); margin: 14px 0; }
.badge { display: inline-block; padding: 2px 7px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; background: var(--green-dark); color: var(--gold); margin-left: 6px; }
.alert { background: #2a1a0a; border: 1px solid #a06020; border-radius: 8px; padding: 10px 13px; font-size: 0.83rem; color: #f0a040; margin-bottom: 12px; }
.total-info { text-align: center; font-size: 0.83rem; margin-bottom: 10px; }
.final-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.final-row label { min-width: 110px; margin: 0; font-size: 0.95rem; color: var(--text); }
.final-row input { flex: 1; }
.btn-group { display: flex; flex-direction: column; gap: 8px; }
.stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.stat-card { background: #0f2d1a; border: 1px solid var(--card-border); border-radius: 10px; padding: 12px; text-align: center; }
.stat-val { font-size: 1.5rem; font-weight: 700; color: var(--gold); }
.stat-label { font-size: 0.72rem; color: var(--text-muted); margin-top: 2px; }
.tg-bottom-spacer { height: 80px; }
.loading { text-align: center; color: var(--text-muted); padding: 24px; font-size: 0.9rem; }
.spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--card-border); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="page-auth" class="page">
  <div class="auth-box">
    <div style="font-size:3rem;margin-bottom:12px">üÉè</div>
    <h2>–ü–æ–∫–µ—Ä —Ç—Ä–µ–∫–µ—Ä</h2>
    <p>–í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞</p>
    <input type="password" id="auth-input" placeholder="–ü–∞—Ä–æ–ª—å"
      style="margin-bottom:12px;text-align:center;font-size:1.1rem;letter-spacing:4px"
      onkeydown="if(event.key==='Enter')checkPassword()">
    <button class="btn btn-gold btn-full" onclick="checkPassword()">–í–æ–π—Ç–∏</button>
    <div class="auth-error" id="auth-error"></div>
  </div>
</div>

<div id="page-setup" class="page">
  <h1>üÉè –ü–æ–∫–µ—Ä</h1>
  <p class="subtitle">–¢—Ä–µ–∫–µ—Ä —Ñ–∏—à–µ–∫ ¬∑ –ò—Å—Ç–æ—Ä–∏—è ¬∑ –†–µ–π—Ç–∏–Ω–≥</p>
  <div class="nav-tabs">
    <div class="nav-tab active" onclick="switchTab('tab-setup',this)">‚öôÔ∏è –ò–≥—Ä–∞</div>
    <div class="nav-tab" onclick="switchTab('tab-leaderboard',this)">üèÜ –†–µ–π—Ç–∏–Ω–≥</div>
    <div class="nav-tab" onclick="switchTab('tab-history',this)">üìö –ò—Å—Ç–æ—Ä–∏—è</div>
  </div>
  <div id="tab-setup" class="tab-content" style="display:block;padding-top:14px">
    <div class="section">
      <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <div class="row">
        <div><label>–§–∏—à–µ–∫ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ</label><input type="number" id="chips-per-player" value="100" min="1" inputmode="numeric"></div>
        <div><label>–§–∏—à–µ–∫ = 1 —Ä—É–±</label><input type="number" id="chips-per-rub" value="10" min="1" step="0.01" inputmode="decimal"></div>
      </div>
      <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</label><input type="text" id="game-name" placeholder="–ù–∞–ø—Ä: –ü—è—Ç–Ω–∏—Ü–∞ —É –í–∞—Å–∏"></div>
    </div>
    <div class="section">
      <h2>üë• –ò–≥—Ä–æ–∫–∏ <span id="player-count-badge" class="badge">0</span></h2>
      <div id="names-grid" class="names-grid"></div>
      <button class="btn btn-green btn-full" onclick="addPlayerInput()">+ –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
    </div>
    <div style="max-width:600px;margin:0 auto 16px;padding:0 16px">
      <button class="btn btn-gold btn-full" style="font-size:1.05rem;padding:14px" onclick="startGame()">üé≤ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </div>
  </div>
  <div id="tab-leaderboard" class="tab-content" style="display:none;padding-top:14px">
    <div class="section"><h2>üèÜ –†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</h2><div id="leaderboard-content"></div></div>
    <div class="section"><h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2><div id="stats-content"></div></div>
  </div>
  <div id="tab-history" class="tab-content" style="display:none;padding-top:14px">
    <div class="section"><h2>üìö –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</h2><div id="history-content"></div></div>
  </div>
  <div class="tg-bottom-spacer"></div>
</div>

<div id="page-game" class="page">
  <h1>üÉè –ò–¥—ë—Ç –∏–≥—Ä–∞</h1>
  <p class="subtitle" id="game-subtitle"></p>
  <div style="max-width:600px;margin:0 auto 12px;padding:0 12px;display:flex;gap:8px">
    <button class="btn btn-gold" style="flex:2" onclick="showFinalScreen()">üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    <button class="btn btn-blue" style="flex:1" onclick="goBackSetup()">‚öôÔ∏è</button>
  </div>
  <div id="players-grid" class="players-grid"></div>
  <div class="tg-bottom-spacer"></div>
</div>

<div id="page-result" class="page">
  <h1>üèÜ –ò—Ç–æ–≥–∏</h1>
  <div style="max-width:600px;margin:0 auto;padding:0 12px">
    <div class="section" id="final-input-section">
      <h2>üé∞ –ò—Ç–æ–≥–æ–≤—ã–µ —Ñ–∏—à–∫–∏</h2>
      <div class="alert">–ü–µ—Ä–µ—Å—á–∏—Ç–∞–π—Ç–µ —Ñ–∏—à–∫–∏ –∏ –≤–≤–µ–¥–∏—Ç–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.</div>
      <div id="final-inputs"></div>
      <div id="chips-sum-live" style="text-align:right;font-size:0.82rem;color:var(--text-muted);margin-bottom:10px"></div>
      <button class="btn btn-gold btn-full" onclick="calculateResults()">üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ–ª–≥–∏</button>
    </div>
    <div id="results-section" style="display:none">
      <div class="section">
        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
        <div class="total-info" id="chips-balance-info"></div>
        <table class="result-table">
          <thead><tr><th>–ò–≥—Ä–æ–∫</th><th>–í–ª–æ–∂–∏–ª</th><th>–ò—Ç–æ–≥</th><th>¬±‚ÇΩ</th></tr></thead>
          <tbody id="result-tbody"></tbody>
        </table>
      </div>
      <div class="section">
        <h2>üí∏ –ö—Ç–æ –∫–æ–º—É –ø–ª–∞—Ç–∏—Ç</h2>
        <ul class="transactions" id="transactions-list"></ul>
        <div class="divider"></div>
        <div class="btn-group">
          <button class="btn btn-gold btn-full" id="save-btn" onclick="saveAndNewGame()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –Ω–æ–≤–∞—è –∏–≥—Ä–∞</button>
          <button class="btn btn-green btn-full" onclick="newGame()">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞ (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)</button>
          <button class="btn btn-blue btn-full" onclick="showFinalScreen()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∏—à–∫–∏</button>
        </div>
      </div>
    </div>
  </div>
  <div class="tg-bottom-spacer"></div>
</div>

<script>
var SUPABASE_URL = 'https://vylimuuiwyzlwqrpsgrp.supabase.co';
var SUPABASE_KEY = 'sb_publishable_0SUpAeZT5ytMKz2k_sNLQg_ad0n6C9L';
var APP_PASSWORD = '2769allin';
var AUTH_KEY = 'poker_auth_v1';

var tg = window.Telegram && window.Telegram.WebApp;
if (tg) { tg.ready(); tg.expand(); }

function sbFetch(path, options) {
  options = options || {};
  return fetch(SUPABASE_URL + '/rest/v1/' + path, Object.assign({}, options, {
    headers: Object.assign({
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': options.prefer || 'return=representation'
    }, options.headers || {})
  })).then(function(res) {
    if (!res.ok) return res.text().then(function(t) { throw new Error(t); });
    return res.text().then(function(t) { return t ? JSON.parse(t) : null; });
  });
}

function checkPassword() {
  var val = document.getElementById('auth-input').value;
  if (val === APP_PASSWORD) {
    localStorage.setItem(AUTH_KEY, '1');
    showPage('page-setup');
    initSetup();
  } else {
    document.getElementById('auth-error').textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
    if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
  }
}

function initApp() {
  if (localStorage.getItem(AUTH_KEY) === '1') {
    showPage('page-setup');
    initSetup();
  } else {
    showPage('page-auth');
    setTimeout(function() {
      var inp = document.getElementById('auth-input');
      if (inp) inp.focus();
    }, 300);
  }
}

var state = { players: [], chipsPerRub: 10, gameName: '' };

function switchTab(tabId, el) {
  document.querySelectorAll('.tab-content').forEach(function(t) { t.style.display = 'none'; });
  document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
  document.getElementById(tabId).style.display = 'block';
  el.classList.add('active');
  if (tabId === 'tab-leaderboard') renderLeaderboard();
  if (tabId === 'tab-history') renderHistory();
}

function initSetup() {
  if (document.getElementById('names-grid').children.length === 0) {
    addPlayerInput(''); addPlayerInput(''); addPlayerInput('');
  }
}

function addPlayerInput(name) {
  name = name || '';
  var grid = document.getElementById('names-grid');
  var idx = grid.children.length;
  var wrap = document.createElement('div');
  wrap.className = 'name-input-wrap';
  var inp = document.createElement('input');
  inp.type = 'text';
  inp.placeholder = '–ò–º—è –∏–≥—Ä–æ–∫–∞ ' + (idx + 1);
  inp.value = name;
  inp.oninput = updatePlayerCount;
  var btn = document.createElement('button');
  btn.className = 'remove-btn';
  btn.textContent = '√ó';
  btn.onclick = function() { wrap.remove(); updatePlayerCount(); };
  wrap.appendChild(inp);
  wrap.appendChild(btn);
  grid.appendChild(wrap);
  updatePlayerCount();
  if (!name) setTimeout(function() { inp.focus(); }, 50);
}

function updatePlayerCount() {
  document.getElementById('player-count-badge').textContent =
    document.getElementById('names-grid').querySelectorAll('input').length;
}

function startGame() {
  var names = Array.from(document.getElementById('names-grid').querySelectorAll('input'))
    .map(function(i) { return i.value.trim(); }).filter(Boolean);
  var chipsPerPlayer = parseInt(document.getElementById('chips-per-player').value) || 100;
  var chipsPerRub = parseFloat(document.getElementById('chips-per-rub').value) || 10;
  var gameName = document.getElementById('game-name').value.trim();
  if (names.length < 2) { showAlert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã 2 –∏–≥—Ä–æ–∫–æ–≤!'); return; }
  if (new Set(names).size !== names.length) { showAlert('–ò–º–µ–Ω–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏!'); return; }
  state.chipsPerRub = chipsPerRub;
  state.gameName = gameName || ('–ò–≥—Ä–∞ ' + formatDate(new Date()));
  state.players = names.map(function(name) {
    return { name: name, startChips: chipsPerPlayer, currentChips: chipsPerPlayer, history: ['–°—Ç–∞—Ä—Ç: +' + chipsPerPlayer] };
  });
  showPage('page-game');
  renderGamePage();
}

function renderGamePage() {
  document.getElementById('game-subtitle').textContent = state.gameName + ' ¬∑ 1‚ÇΩ = ' + state.chipsPerRub + ' —Ñ–∏—à–µ–∫';
  var grid = document.getElementById('players-grid');
  grid.innerHTML = '';
  state.players.forEach(function(p, i) {
    var card = document.createElement('div');
    card.className = 'player-card';
    card.id = 'pcard-' + i;
    card.innerHTML =
      '<div class="player-name">üë§ ' + escHtml(p.name) + '</div>' +
      '<div class="player-chips-display">–§–∏—à–∫–∏: <span id="chips-' + i + '">' + p.currentChips + '</span> ¬∑ ‚âà <span id="rub-' + i + '">' + (p.currentChips/state.chipsPerRub).toFixed(2) + '</span> ‚ÇΩ</div>' +
      '<div class="player-chips-display" style="font-size:0.78rem;color:#5a8a6a">–í–ª–æ–∂–µ–Ω–æ: <span id="start-' + i + '">' + p.startChips + '</span></div>' +
      '<div class="player-actions">' +
        '<input type="number" id="add-input-' + i + '" placeholder="–î–æ–∫—É–ø —Ñ–∏—à–µ–∫" min="1" inputmode="numeric">' +
        '<button class="btn btn-green btn-sm" onclick="addChips(' + i + ')">+ –î–æ–∫—É–ø</button>' +
      '</div>' +
      '<div class="history-log" id="history-' + i + '"></div>';
    grid.appendChild(card);
    document.getElementById('add-input-' + i).addEventListener('keydown', (function(idx) {
      return function(e) { if (e.key === 'Enter') addChips(idx); };
    })(i));
    updateHistoryLog(i);
  });
}

function addChips(idx) {
  var input = document.getElementById('add-input-' + idx);
  var amount = parseInt(input.value);
  if (!amount || amount < 1) { input.focus(); return; }
  var p = state.players[idx];
  p.currentChips += amount; p.startChips += amount;
  var t = new Date().toTimeString().slice(0,5);
  p.history.push(t + ' –î–æ–∫—É–ø: +' + amount);
  document.getElementById('chips-' + idx).textContent = p.currentChips;
  document.getElementById('rub-' + idx).textContent = (p.currentChips/state.chipsPerRub).toFixed(2);
  document.getElementById('start-' + idx).textContent = p.startChips;
  updateHistoryLog(idx);
  var card = document.getElementById('pcard-' + idx);
  card.style.borderColor = '#60e080';
  setTimeout(function() { card.style.borderColor = ''; }, 700);
  input.value = ''; input.focus();
  if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}

function updateHistoryLog(i) {
  var log = document.getElementById('history-' + i);
  if (log) log.innerHTML = state.players[i].history.slice(-5).reverse()
    .map(function(h) { return '<div class="history-item">üìã ' + escHtml(h) + '</div>'; }).join('');
}

function showFinalScreen() {
  showPage('page-result');
  document.getElementById('final-input-section').style.display = 'block';
  document.getElementById('results-section').style.display = 'none';
  var container = document.getElementById('final-inputs');
  container.innerHTML = '';
  state.players.forEach(function(p, i) {
    var row = document.createElement('div');
    row.className = 'final-row';
    var lbl = document.createElement('label');
    lbl.textContent = p.name;
    var inp = document.createElement('input');
    inp.type = 'number'; inp.id = 'final-' + i; inp.value = p.currentChips; inp.min = 0; inp.setAttribute('inputmode','numeric');
    inp.oninput = updateChipsSum;
    row.appendChild(lbl); row.appendChild(inp);
    container.appendChild(row);
  });
  updateChipsSum();
}

function updateChipsSum() {
  var total = state.players.reduce(function(s,_,i) {
    var el = document.getElementById('final-'+i);
    return s + (el ? parseInt(el.value)||0 : 0);
  }, 0);
  var invested = state.players.reduce(function(s,p) { return s+p.startChips; }, 0);
  var diff = total - invested;
  var el = document.getElementById('chips-sum-live');
  el.innerHTML = diff === 0
    ? '‚úÖ –°—É–º–º–∞: <b style="color:#60e080">' + total + '</b> = ' + invested + ' (OK)'
    : '‚ö†Ô∏è –°—É–º–º–∞: <b style="color:#f0a040">' + total + '</b>, –Ω—É–∂–Ω–æ ' + invested + ' (—Ä–∞–∑–Ω–∏—Ü–∞: ' + (diff>0?'+':'') + diff + ')';
}

function calculateResults() {
  var finals = state.players.map(function(p, i) {
    var v = parseInt(document.getElementById('final-' + i).value);
    if (isNaN(v) || v < 0) { showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ —Ñ–∏—à–µ–∫ –¥–ª—è ' + p.name); throw ''; }
    return v;
  });
  state.players.forEach(function(p, i) { p.finalChips = finals[i]; });
  var totalStart = state.players.reduce(function(s,p){return s+p.startChips;},0);
  var totalFinal = state.players.reduce(function(s,p){return s+p.finalChips;},0);
  var bi = document.getElementById('chips-balance-info');
  bi.innerHTML = totalStart !== totalFinal
    ? '‚ö†Ô∏è –í–ª–æ–∂–µ–Ω–æ: <b>'+totalStart+'</b>, –∏—Ç–æ–≥–æ: <b>'+totalFinal+'</b> ‚Äî —Ä–∞–∑–Ω–∏—Ü–∞ '+(totalFinal-totalStart)
    : '‚úÖ –ë–∞–ª–∞–Ω—Å —Å—Ö–æ–¥–∏—Ç—Å—è: '+totalFinal+' —Ñ–∏—à–µ–∫';
  bi.style.color = totalStart !== totalFinal ? '#f0a040' : '#60e080';

  var sorted = state.players.slice().sort(function(a,b){return (b.finalChips-b.startChips)-(a.finalChips-a.startChips);});
  document.getElementById('result-tbody').innerHTML = sorted.map(function(p) {
    var diff = p.finalChips-p.startChips, dR=(diff/state.chipsPerRub).toFixed(2);
    var cls=diff>0?'pos':diff<0?'neg':'zero', sign=diff>0?'+':'';
    return '<tr><td><b>'+escHtml(p.name)+'</b></td><td>'+p.startChips+'</td><td>'+p.finalChips+'</td><td class="'+cls+'">'+sign+dR+' ‚ÇΩ</td></tr>';
  }).join('');

  var txs = minimizeTransactions(state.players.map(function(p){return {name:p.name,balance:(p.finalChips-p.startChips)/state.chipsPerRub};}));
  var txList = document.getElementById('transactions-list');
  txList.innerHTML = '';
  if (!txs.length) { txList.innerHTML = '<li>üéâ –í—Å–µ –≤ —Ä–∞—Å—á—ë—Ç–µ!</li>'; }
  else txs.forEach(function(t, idx) {
    var li = document.createElement('li'); li.id = 'tx-'+idx;
    li.innerHTML = '<span>üí∏ <b>'+escHtml(t.from)+'</b></span><span class="arrow">‚Üí</span><span><b>'+escHtml(t.to)+'</b></span><span class="amount">'+t.amount.toFixed(2)+' ‚ÇΩ</span><button class="settle-btn" onclick="settleTx('+idx+')">‚úì</button>';
    txList.appendChild(li);
  });
  document.getElementById('final-input-section').style.display = 'none';
  document.getElementById('results-section').style.display = 'block';
  if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
}

function minimizeTransactions(balances) {
  var eps=0.005;
  var debtors=balances.filter(function(b){return b.balance<-eps;}).map(function(b){return Object.assign({},b);}).sort(function(a,b){return a.balance-b.balance;});
  var creditors=balances.filter(function(b){return b.balance>eps;}).map(function(b){return Object.assign({},b);}).sort(function(a,b){return b.balance-a.balance;});
  var txs=[],di=0,ci=0;
  while(di<debtors.length&&ci<creditors.length){
    var d=debtors[di],c=creditors[ci],amount=Math.min(-d.balance,c.balance);
    if(amount>eps) txs.push({from:d.name,to:c.name,amount:amount});
    d.balance+=amount; c.balance-=amount;
    if(Math.abs(d.balance)<eps)di++; if(Math.abs(c.balance)<eps)ci++;
  }
  return txs;
}

function settleTx(idx) {
  var li=document.getElementById('tx-'+idx);
  li.classList.add('settled'); li.querySelector('.settle-btn').disabled=true;
  if(tg&&tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
}

function saveAndNewGame() {
  var btn = document.getElementById('save-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> –°–æ—Ö—Ä–∞–Ω—è–µ–º...';
  sbFetch('games', {
    method: 'POST',
    body: JSON.stringify({ name: state.gameName, date_str: formatDate(new Date()), chips_per_rub: state.chipsPerRub })
  }).then(function(games) {
    var gameId = games[0].id;
    var playersData = state.players.map(function(p) {
      return { game_id: gameId, name: p.name, start_chips: p.startChips, final_chips: p.finalChips || p.currentChips, diff_rub: ((p.finalChips||p.currentChips)-p.startChips)/state.chipsPerRub };
    });
    return sbFetch('game_players', { method: 'POST', body: JSON.stringify(playersData) });
  }).then(function() {
    if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    showAlert('‚úÖ –ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
    newGame();
  }).catch(function(e) {
    btn.disabled = false;
    btn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –Ω–æ–≤–∞—è –∏–≥—Ä–∞';
    showAlert('‚ùå –û—à–∏–±–∫–∞: ' + e.message);
  });
}

function renderLeaderboard() {
  var lbDiv = document.getElementById('leaderboard-content');
  var statsDiv = document.getElementById('stats-content');
  lbDiv.innerHTML = '<div class="loading"><span class="spinner"></span>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  sbFetch('game_players?select=name,diff_rub').then(function(players) {
    if (!players || !players.length) {
      lbDiv.innerHTML = '<div class="empty-state">üÉè –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–≥—Ä</div>';
      statsDiv.innerHTML = ''; return;
    }
    var agg = {};
    players.forEach(function(p) {
      if (!agg[p.name]) agg[p.name] = { name: p.name, games: 0, totalDiffRub: 0, wins: 0, losses: 0 };
      var a = agg[p.name];
      a.games++; a.totalDiffRub += p.diff_rub;
      if (p.diff_rub > 0.005) a.wins++;
      else if (p.diff_rub < -0.005) a.losses++;
    });
    var sorted = Object.values(agg).sort(function(a,b){return b.totalDiffRub-a.totalDiffRub;});
    var medals = ['ü•á','ü•à','ü•â'];
    lbDiv.innerHTML = '<table class="leader-table"><thead><tr><th>#</th><th>–ò–≥—Ä–æ–∫</th><th>–ò–≥—Ä—ã</th><th>W/L</th><th>WR%</th><th>–ò—Ç–æ–≥–æ ‚ÇΩ</th></tr></thead><tbody>' +
      sorted.map(function(p,i) {
        var cls=p.totalDiffRub>0.005?'pos':p.totalDiffRub<-0.005?'neg':'zero';
        var sign=p.totalDiffRub>0?'+':'';
        var wr=p.games>0?Math.round(p.wins/p.games*100):0;
        return '<tr class="'+(i<3?'rank-'+(i+1):'')+'"><td>'+(i<3?medals[i]:(i+1)+'.')+'</td><td><b>'+escHtml(p.name)+'</b></td><td>'+p.games+'</td><td>'+p.wins+'/'+p.losses+'</td><td>'+wr+'%</td><td class="'+cls+'">'+sign+p.totalDiffRub.toFixed(2)+' ‚ÇΩ</td></tr>';
      }).join('') + '</tbody></table>';
    return sbFetch('games?select=id').then(function(gamesCount) {
      statsDiv.innerHTML = '<div class="stats-grid">' +
        '<div class="stat-card"><div class="stat-val">'+(gamesCount?gamesCount.length:0)+'</div><div class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div></div>' +
        '<div class="stat-card"><div class="stat-val">'+sorted.length+'</div><div class="stat-label">–ò–≥—Ä–æ–∫–æ–≤</div></div>' +
        '<div class="stat-card"><div class="stat-val" style="font-size:0.95rem">'+(sorted.length>0?escHtml(sorted[0].name):'‚Äî')+'</div><div class="stat-label">–õ—É—á—à–∏–π</div></div>' +
        '</div>';
    });
  }).catch(function() {
    lbDiv.innerHTML = '<div class="empty-state">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
  });
}

function renderHistory() {
  var div = document.getElementById('history-content');
  div.innerHTML = '<div class="loading"><span class="spinner"></span>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  sbFetch('games?select=id,name,date_str,is_closed,game_players(name,start_chips,final_chips,diff_rub)&order=created_at.desc').then(function(games) {
    if (!games || !games.length) { div.innerHTML = '<div class="empty-state">üìö –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>'; return; }
    div.innerHTML = games.map(function(g) {
      var sorted = (g.game_players||[]).slice().sort(function(a,b){return b.diff_rub-a.diff_rub;});
      var badge = g.is_closed ? '<span class="badge" style="background:var(--red);color:#fff;margin-left:6px;">–ó–∞–∫—Ä—ã—Ç–∞</span>' : '<span class="badge" style="background:var(--green-dark);color:var(--gold);margin-left:6px;">–û—Ç–∫—Ä—ã—Ç–∞</span>';
      var checkbox = '<input type="checkbox" class="game-checkbox" data-id="'+g.id+'" style="width:18px;height:18px;margin-right:8px;cursor:pointer;accent-color:var(--gold);flex-shrink:0;">';
      var deleteBtn = '<button class="delete-game-btn" onclick="deleteGame('+g.id+')"' + (g.is_closed ? ' disabled style="opacity:0.4;cursor:not-allowed;"' : '') + '>üóë –£–¥–∞–ª–∏—Ç—å</button>';
      var toggleBtn = '<button class="settle-btn" onclick="toggleClosed('+g.id+','+!!g.is_closed+')" style="margin-right:6px;">'+(g.is_closed ? 'üîì –û—Ç–∫—Ä—ã—Ç—å' : 'üîí –ó–∞–∫—Ä—ã—Ç—å')+'</button>';
      return '<div class="history-card">' +
        '<div class="history-card-header" style="flex-wrap:wrap;gap:8px;">' +
          '<div style="display:flex;align-items:center;flex:1;min-width:0;">' +
            checkbox +
            '<div><div class="history-card-title">üÉè '+escHtml(g.name)+badge+'</div><div class="history-card-date">'+(g.date_str||'')+'</div></div>' +
          '</div>' +
          '<div style="display:flex;gap:6px;align-items:center;flex-shrink:0;">' + toggleBtn + deleteBtn + '</div>' +
        '</div>' +
        '<table class="history-mini-table"><thead><tr><th>–ò–≥—Ä–æ–∫</th><th>–í–ª–æ–∂–∏–ª</th><th>–ò—Ç–æ–≥</th><th>¬±‚ÇΩ</th></tr></thead><tbody>' +
        sorted.map(function(p) {
          var cls=p.diff_rub>0.005?'pos':p.diff_rub<-0.005?'neg':'zero';
          var sign=p.diff_rub>0?'+':'';
          return '<tr><td>'+escHtml(p.name)+'</td><td>'+p.start_chips+'</td><td>'+p.final_chips+'</td><td class="'+cls+'">'+sign+p.diff_rub.toFixed(2)+' ‚ÇΩ</td></tr>';
        }).join('') + '</tbody></table></div>';
    }).join('');
    document.querySelectorAll('.game-checkbox').forEach(function(cb) {
      cb.addEventListener('change', updateSelectedDebts);
    });
    updateSelectedDebts();
  }).catch(function() {
    div.innerHTML = '<div class="empty-state">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
  });
}

function toggleClosed(gameId, isClosed) {
  sbFetch('games?id=eq.' + gameId, {
    method: 'PATCH',
    headers: { 'Prefer': 'return=minimal' },
    body: JSON.stringify({ is_closed: !isClosed })
  }).then(function() {
    renderHistory();
  }).catch(function(e) {
    showAlert('–û—à–∏–±–∫–∞: ' + e.message);
  });
}

function aggregateBalances(players) {
  var agg = {};
  players.forEach(function(p) {
    if (!agg[p.name]) agg[p.name] = { name: p.name, balance: 0 };
    agg[p.name].balance += (p.diff_rub || 0);
  });
  return Object.values(agg);
}

function updateSelectedDebts() {
  var selected = Array.from(document.querySelectorAll('.game-checkbox:checked')).map(function(cb){ return cb.dataset.id; });
  var panel = document.getElementById('debts-panel');
  if (!selected.length) {
    if (panel) panel.remove();
    return;
  }
  sbFetch('game_players?game_id=in.(' + selected.join(',') + ')&select=name,diff_rub').then(function(players) {
    if (!players || !players.length) return;
    var balances = aggregateBalances(players);
    var txs = minimizeTransactions(balances);
    if (!panel) {
      panel = document.createElement('div');
      panel.id = 'debts-panel';
      panel.style.cssText = 'position:sticky;bottom:0;background:var(--card-bg);border:1px solid var(--card-border);border-radius:14px 14px 0 0;padding:14px 16px;margin-top:12px;z-index:200;';
      document.getElementById('history-content').appendChild(panel);
    }
    var html = '<div style="color:var(--gold);font-weight:700;margin-bottom:10px;">üí∞ –ò—Ç–æ–≥–æ–≤—ã–µ –¥–æ–ª–≥–∏ –∑–∞ ' + selected.length + ' –∏–≥—Ä:</div>';
    if (!txs.length) {
      html += '<div style="color:var(--text-muted);">–í—Å–µ –∫–≤–∏—Ç—ã!</div>';
    } else {
      html += '<ul class="transactions" style="margin:0;">' +
        txs.map(function(t) {
          return '<li><span><b>'+escHtml(t.from)+'</b></span><span class="arrow">‚Üí</span><span><b>'+escHtml(t.to)+'</b></span><span class="amount">'+t.amount.toFixed(2)+' ‚ÇΩ</span></li>';
        }).join('') + '</ul>';
    }
    panel.innerHTML = html;
  }).catch(function(e) {
    showAlert('–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –¥–æ–ª–≥–æ–≤: ' + e.message);
  });
}

function deleteGame(gameId) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∏–≥—Ä—É?')) return;
  sbFetch('game_players?game_id=eq.' + gameId, {
    method: 'DELETE',
    headers: { 'Prefer': 'return=minimal' }
  })
  .then(function() {
    return sbFetch('games?id=eq.' + gameId, {
      method: 'DELETE',
      headers: { 'Prefer': 'return=minimal' }
    });
  })
  .then(function() {
    renderHistory();
  })
  .catch(function(e) {
    showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + e.message);
  });
}

function showPage(id) {
  document.querySelectorAll('.page').forEach(function(p){p.classList.remove('active');});
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}
function goBackSetup() { showPage('page-setup'); }
function newGame() {
  showPage('page-setup');
  document.querySelectorAll('.tab-content').forEach(function(t){t.style.display='none';});
  document.querySelectorAll('.nav-tab').forEach(function(t){t.classList.remove('active');});
  document.getElementById('tab-setup').style.display='block';
  document.querySelectorAll('.nav-tab')[0].classList.add('active');
}
function formatDate(d) {
  return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric'})+' '+d.toTimeString().slice(0,5);
}
function escHtml(s) {
  if(!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function showAlert(msg) {
  if(tg&&tg.showAlert) tg.showAlert(msg); else alert(msg);
}

initApp();
</script>
</body>
</html>
