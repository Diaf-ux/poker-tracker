<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ü–æ–∫–µ—Ä —Å –¥—Ä—É–∑—å—è–º–∏</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  :root {
    --green: #1a6b3c; --green-dark: #124d2c; --green-light: #2a9d5c;
    --gold: #f0c040; --gold-dark: #c89a20;
    --bg: #0f2d1a; --card-bg: #163824; --card-border: #2d6040;
    --text: #e8f5ee; --text-muted: #8bb89a;
    --red: #e05050; --red-dark: #b03030; --blue: #4090d0;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  html, body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    min-height: 100dvh;
    overscroll-behavior: none;
  }
  body { padding-bottom: calc(16px + var(--safe-bottom)); }

  h1 { text-align: center; padding: 16px 16px 6px; font-size: 1.6rem; color: var(--gold); letter-spacing: 1px; text-shadow: 0 0 20px rgba(240,192,64,0.4); }
  .subtitle { text-align: center; color: var(--text-muted); font-size: 0.82rem; margin-bottom: 16px; }

  .section { max-width: 600px; margin: 0 auto 16px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 14px; padding: 16px; }
  .section h2 { color: var(--gold); font-size: 1rem; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }

  label { display: block; font-size: 0.82rem; color: var(--text-muted); margin-bottom: 4px; }
  input[type="text"], input[type="number"] {
    width: 100%; background: #0f2d1a; border: 1px solid var(--card-border);
    border-radius: 8px; color: var(--text); padding: 11px 14px;
    font-size: 16px; /* prevents zoom on iOS */ outline: none; transition: border-color 0.2s;
  }
  input:focus { border-color: var(--gold); }

  .row { display: flex; gap: 10px; margin-bottom: 12px; }
  .row > div { flex: 1; }

  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    padding: 12px 20px; border: none; border-radius: 10px;
    font-size: 0.95rem; font-weight: 600; cursor: pointer;
    transition: transform 0.1s, filter 0.15s;
    min-height: 44px; /* touch target */
  }
  .btn:active { transform: scale(0.96); filter: brightness(0.9); }
  .btn-gold { background: var(--gold); color: #1a1a00; }
  .btn-green { background: var(--green-light); color: white; }
  .btn-green:hover { background: var(--green); }
  .btn-red { background: var(--red); color: white; }
  .btn-blue { background: var(--blue); color: white; }
  .btn-sm { padding: 9px 13px; font-size: 0.82rem; min-height: 38px; }
  .btn-full { width: 100%; }

  /* NAV */
  .nav-tabs {
    display: flex; max-width: 600px; margin: 0 auto;
    background: var(--card-bg); border-bottom: 2px solid var(--card-border);
    position: sticky; top: 0; z-index: 100;
  }
  .nav-tab {
    flex: 1; padding: 11px 4px; text-align: center; cursor: pointer;
    font-size: 0.8rem; font-weight: 600; color: var(--text-muted);
    border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s;
    min-height: 44px; display: flex; align-items: center; justify-content: center;
  }
  .nav-tab.active { color: var(--gold); border-bottom-color: var(--gold); }

  /* NAMES GRID */
  .names-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
  .name-input-wrap { position: relative; }
  .name-input-wrap input { padding-right: 42px; }
  .remove-btn {
    position: absolute; right: 0; top: 0; height: 100%; width: 42px;
    background: none; border: none; color: var(--red); cursor: pointer;
    font-size: 1.3rem; display: flex; align-items: center; justify-content: center;
  }

  /* PAGES */
  .page { display: none; }
  .page.active { display: block; }

  /* PLAYERS GRID */
  .players-grid { display: flex; flex-direction: column; gap: 10px; max-width: 600px; margin: 0 auto 24px; padding: 0 12px; }
  .player-card { background: var(--card-bg); border: 1.5px solid var(--card-border); border-radius: 12px; padding: 14px; transition: border-color 0.3s; }
  .player-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .player-name { font-size: 1.05rem; font-weight: 700; color: var(--gold); }
  .player-chips-display { font-size: 0.9rem; color: var(--text-muted); line-height: 1.6; }
  .player-chips-display span { color: var(--text); font-weight: 600; }
  .player-actions { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
  .player-actions input { flex: 1; }
  .history-log { max-height: 90px; overflow-y: auto; margin-top: 8px; }
  .history-item { font-size: 0.73rem; color: var(--text-muted); padding: 2px 0; border-bottom: 1px solid #1e4a2c; }

  /* RESULT */
  .result-table { width: 100%; border-collapse: collapse; margin-bottom: 16px; font-size: 0.88rem; }
  .result-table th { background: var(--green-dark); color: var(--gold); padding: 9px 10px; text-align: left; font-size: 0.78rem; }
  .result-table td { padding: 9px 10px; border-bottom: 1px solid var(--card-border); }
  .result-table tr:last-child td { border: none; }
  .pos { color: #60e080; font-weight: 700; }
  .neg { color: var(--red); font-weight: 700; }
  .zero { color: var(--text-muted); }

  .transactions { list-style: none; }
  .transactions li {
    background: #0f2d1a; border: 1px solid var(--card-border); border-radius: 8px;
    padding: 11px 13px; margin-bottom: 8px; font-size: 0.9rem;
    display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  }
  .transactions li .arrow { color: var(--gold); }
  .transactions li .amount { margin-left: auto; font-weight: 700; color: var(--gold); }
  .settled { opacity: 0.4; text-decoration: line-through; }
  .settle-btn { background: none; border: 1px solid var(--green-light); color: var(--green-light); border-radius: 6px; padding: 4px 9px; font-size: 0.75rem; cursor: pointer; min-height: 30px; }

  /* LEADERBOARD */
  .leader-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .leader-table th { background: var(--green-dark); color: var(--gold); padding: 9px 10px; text-align: left; font-size: 0.78rem; }
  .leader-table td { padding: 9px 10px; border-bottom: 1px solid var(--card-border); }
  .leader-table tr:last-child td { border: none; }
  .rank-1 td:first-child { color: #ffd700; }
  .rank-2 td:first-child { color: #c0c0c0; }
  .rank-3 td:first-child { color: #cd7f32; }

  /* HISTORY */
  .history-card { background: #0f2d1a; border: 1px solid var(--card-border); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
  .history-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 6px; }
  .history-card-title { font-weight: 700; color: var(--gold); font-size: 0.95rem; }
  .history-card-date { font-size: 0.75rem; color: var(--text-muted); }
  .history-mini-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  .history-mini-table th { color: var(--text-muted); padding: 4px 7px; border-bottom: 1px solid var(--card-border); }
  .history-mini-table td { padding: 5px 7px; border-bottom: 1px solid #1a3a28; }
  .history-mini-table tr:last-child td { border: none; }
  .delete-game-btn { background: none; border: 1px solid #3a2020; color: var(--red); border-radius: 6px; padding: 4px 9px; font-size: 0.75rem; cursor: pointer; }

  .empty-state { text-align: center; color: var(--text-muted); padding: 36px 0; font-size: 0.92rem; }
  .divider { height: 1px; background: var(--card-border); margin: 14px 0; }
  .badge { display: inline-block; padding: 2px 7px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; background: var(--green-dark); color: var(--gold); margin-left: 6px; }
  .alert { background: #2a1a0a; border: 1px solid #a06020; border-radius: 8px; padding: 10px 13px; font-size: 0.83rem; color: #f0a040; margin-bottom: 12px; }
  .total-info { text-align: center; font-size: 0.83rem; margin-bottom: 10px; }
  .final-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .final-row label { min-width: 110px; margin: 0; font-size: 0.95rem; color: var(--text); }
  .final-row input { flex: 1; }
  .btn-group { display: flex; flex-direction: column; gap: 8px; }
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
  .stat-card { background: #0f2d1a; border: 1px solid var(--card-border); border-radius: 10px; padding: 12px; text-align: center; }
  .stat-val { font-size: 1.5rem; font-weight: 700; color: var(--gold); }
  .stat-label { font-size: 0.72rem; color: var(--text-muted); margin-top: 2px; }

  /* TG main button area compensation */
  .tg-bottom-spacer { height: 80px; }
</style>
</head>
<body>

<!-- ===== SETUP PAGE ===== -->
<div id="page-setup" class="page active">
  <h1>üÉè –ü–æ–∫–µ—Ä</h1>
  <p class="subtitle">–¢—Ä–µ–∫–µ—Ä —Ñ–∏—à–µ–∫ ¬∑ –ò—Å—Ç–æ—Ä–∏—è ¬∑ –†–µ–π—Ç–∏–Ω–≥</p>

  <div class="nav-tabs">
    <div class="nav-tab active" onclick="switchTab('tab-setup', this)">‚öôÔ∏è –ò–≥—Ä–∞</div>
    <div class="nav-tab" onclick="switchTab('tab-leaderboard', this)">üèÜ –†–µ–π—Ç–∏–Ω–≥</div>
    <div class="nav-tab" onclick="switchTab('tab-history', this)">üìö –ò—Å—Ç–æ—Ä–∏—è</div>
  </div>

  <!-- Tab: Setup -->
  <div id="tab-setup" class="tab-content" style="display:block; padding-top:14px;">
    <div class="section">
      <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <div class="row">
        <div>
          <label>–§–∏—à–µ–∫ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ</label>
          <input type="number" id="chips-per-player" value="100" min="1" inputmode="numeric">
        </div>
        <div>
          <label>–§–∏—à–µ–∫ = 1 —Ä—É–±</label>
          <input type="number" id="chips-per-rub" value="10" min="1" step="0.01" inputmode="decimal">
        </div>
      </div>
      <div>
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</label>
        <input type="text" id="game-name" placeholder="–ù–∞–ø—Ä: –ü—è—Ç–Ω–∏—Ü–∞ —É –í–∞—Å–∏">
      </div>
    </div>

    <div class="section">
      <h2>üë• –ò–≥—Ä–æ–∫–∏ <span id="player-count-badge" class="badge">0</span></h2>
      <div id="names-grid" class="names-grid"></div>
      <button class="btn btn-green btn-full" onclick="addPlayerInput()">+ –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
    </div>

    <div style="max-width:600px; margin:0 auto 16px; padding:0 16px;">
      <button class="btn btn-gold btn-full" style="font-size:1.05rem; padding:14px;" onclick="startGame()">
        üé≤ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
      </button>
    </div>
  </div>

  <!-- Tab: Leaderboard -->
  <div id="tab-leaderboard" class="tab-content" style="display:none; padding-top:14px;">
    <div class="section">
      <h2>üèÜ –†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</h2>
      <div id="leaderboard-content"></div>
    </div>
    <div class="section">
      <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
      <div id="stats-content"></div>
    </div>
  </div>

  <!-- Tab: History -->
  <div id="tab-history" class="tab-content" style="display:none; padding-top:14px;">
    <div class="section">
      <h2>üìö –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</h2>
      <div id="history-content"></div>
    </div>
  </div>
  <div class="tg-bottom-spacer"></div>
</div>

<!-- ===== GAME PAGE ===== -->
<div id="page-game" class="page">
  <h1>üÉè –ò–¥—ë—Ç –∏–≥—Ä–∞</h1>
  <p class="subtitle" id="game-subtitle"></p>
  <div style="max-width:600px; margin:0 auto 12px; padding:0 12px; display:flex; gap:8px;">
    <button class="btn btn-gold" style="flex:2;" onclick="showFinalScreen()">üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    <button class="btn btn-blue" style="flex:1;" onclick="goBackSetup()">‚öôÔ∏è</button>
  </div>
  <div id="players-grid" class="players-grid"></div>
  <div class="tg-bottom-spacer"></div>
</div>

<!-- ===== RESULT PAGE ===== -->
<div id="page-result" class="page">
  <h1>üèÜ –ò—Ç–æ–≥–∏</h1>
  <div style="max-width:600px; margin:0 auto; padding:0 12px;">

    <div class="section" id="final-input-section">
      <h2>üé∞ –ò—Ç–æ–≥–æ–≤—ã–µ —Ñ–∏—à–∫–∏</h2>
      <div class="alert">–ü–µ—Ä–µ—Å—á–∏—Ç–∞–π—Ç–µ —Ñ–∏—à–∫–∏ –∏ –≤–≤–µ–¥–∏—Ç–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.</div>
      <div id="final-inputs"></div>
      <div id="chips-sum-live" style="text-align:right; font-size:0.82rem; color:var(--text-muted); margin-bottom:10px;"></div>
      <button class="btn btn-gold btn-full" onclick="calculateResults()">üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ–ª–≥–∏</button>
    </div>

    <div id="results-section" style="display:none;">
      <div class="section">
        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
        <div class="total-info" id="chips-balance-info"></div>
        <table class="result-table">
          <thead><tr><th>–ò–≥—Ä–æ–∫</th><th>–í–ª–æ–∂–∏–ª</th><th>–ò—Ç–æ–≥</th><th>¬±‚ÇΩ</th></tr></thead>
          <tbody id="result-tbody"></tbody>
        </table>
      </div>
      <div class="section">
        <h2>üí∏ –ö—Ç–æ –∫–æ–º—É –ø–ª–∞—Ç–∏—Ç</h2>
        <ul class="transactions" id="transactions-list"></ul>
        <div class="divider"></div>
        <div class="btn-group">
          <button class="btn btn-gold btn-full" onclick="saveAndNewGame()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –Ω–æ–≤–∞—è –∏–≥—Ä–∞</button>
          <button class="btn btn-green btn-full" onclick="newGame()">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞ (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)</button>
          <button class="btn btn-blue btn-full" onclick="showFinalScreen()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∏—à–∫–∏</button>
        </div>
      </div>
    </div>
  </div>
  <div class="tg-bottom-spacer"></div>
</div>

<script>
// ===== TELEGRAM INIT =====
const tg = window.Telegram && window.Telegram.WebApp;
if (tg) {
  tg.ready();
  tg.expand();
}

// ===== STORAGE =====
const STORAGE_KEY = 'poker_tracker_v2';
function loadData() {
  try { const d = localStorage.getItem(STORAGE_KEY); return d ? JSON.parse(d) : { games: [], players: {} }; }
  catch(e) { return { games: [], players: {} }; }
}
function saveData(data) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

// ===== STATE =====
let state = { players: [], chipsPerRub: 10, gameName: '' };

// ===== TABS =====
function switchTab(tabId, el) {
  document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tabId).style.display = 'block';
  el.classList.add('active');
  if (tabId === 'tab-leaderboard') renderLeaderboard();
  if (tabId === 'tab-history') renderHistory();
}

// ===== SETUP =====
function addPlayerInput(name='') {
  const grid = document.getElementById('names-grid');
  const idx = grid.children.length;
  const wrap = document.createElement('div');
  wrap.className = 'name-input-wrap';
  wrap.innerHTML = `
    <input type="text" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞ ${idx+1}" value="${escHtml(name)}" oninput="updatePlayerCount()">
    <button class="remove-btn" onclick="removePlayerInput(this)">√ó</button>`;
  grid.appendChild(wrap);
  updatePlayerCount();
  if (!name) setTimeout(() => wrap.querySelector('input').focus(), 50);
}
function removePlayerInput(btn) { btn.parentElement.remove(); updatePlayerCount(); }
function updatePlayerCount() {
  document.getElementById('player-count-badge').textContent =
    document.getElementById('names-grid').querySelectorAll('input').length;
}

function startGame() {
  const names = [...document.getElementById('names-grid').querySelectorAll('input')]
    .map(i => i.value.trim()).filter(Boolean);
  const chipsPerPlayer = parseInt(document.getElementById('chips-per-player').value) || 100;
  const chipsPerRub = parseFloat(document.getElementById('chips-per-rub').value) || 10;
  const gameName = document.getElementById('game-name').value.trim();

  if (names.length < 2) { showAlert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã 2 –∏–≥—Ä–æ–∫–æ–≤!'); return; }
  if (new Set(names).size !== names.length) { showAlert('–ò–º–µ–Ω–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏!'); return; }

  state.chipsPerRub = chipsPerRub;
  state.gameName = gameName || ('–ò–≥—Ä–∞ ' + formatDate(new Date()));
  state.players = names.map(name => ({
    name, startChips: chipsPerPlayer, currentChips: chipsPerPlayer,
    history: ['–°—Ç–∞—Ä—Ç: +' + chipsPerPlayer + ' —Ñ–∏—à–µ–∫']
  }));

  showPage('page-game');
  renderGamePage();
}

// ===== GAME PAGE =====
function renderGamePage() {
  document.getElementById('game-subtitle').textContent =
    state.gameName + ' ¬∑ 1‚ÇΩ = ' + state.chipsPerRub + ' —Ñ–∏—à–µ–∫';
  const grid = document.getElementById('players-grid');
  grid.innerHTML = '';
  state.players.forEach((p, i) => {
    const card = document.createElement('div');
    card.className = 'player-card'; card.id = 'pcard-' + i;
    card.innerHTML = `
      <div class="player-header"><div class="player-name">üë§ ${escHtml(p.name)}</div></div>
      <div class="player-chips-display">
        –§–∏—à–∫–∏: <span id="chips-${i}">${p.currentChips}</span> ¬∑ ‚âà <span id="rub-${i}">${(p.currentChips/state.chipsPerRub).toFixed(2)}</span> ‚ÇΩ
      </div>
      <div class="player-chips-display" style="font-size:0.78rem; color:#5a8a6a;">
        –í–ª–æ–∂–µ–Ω–æ: <span id="start-${i}">${p.startChips}</span> —Ñ–∏—à–µ–∫
      </div>
      <div class="player-actions">
        <input type="number" id="add-input-${i}" placeholder="–î–æ–∫—É–ø —Ñ–∏—à–µ–∫" min="1" inputmode="numeric"
          onkeydown="if(event.key==='Enter') addChips(${i})">
        <button class="btn btn-green btn-sm" onclick="addChips(${i})">+ –î–æ–∫—É–ø</button>
      </div>
      <div class="history-log" id="history-${i}"></div>`;
    grid.appendChild(card);
    updateHistoryLog(i);
  });
}

function addChips(idx) {
  const input = document.getElementById('add-input-' + idx);
  const amount = parseInt(input.value);
  if (!amount || amount < 1) { input.focus(); return; }
  const p = state.players[idx];
  p.currentChips += amount; p.startChips += amount;
  const t = new Date().toTimeString().slice(0,5);
  p.history.push(t + ' –î–æ–∫—É–ø: +' + amount + ' (–≤–ª–æ–∂–µ–Ω–æ: ' + p.startChips + ')');
  document.getElementById('chips-' + idx).textContent = p.currentChips;
  document.getElementById('rub-' + idx).textContent = (p.currentChips/state.chipsPerRub).toFixed(2);
  document.getElementById('start-' + idx).textContent = p.startChips;
  updateHistoryLog(idx);
  const card = document.getElementById('pcard-' + idx);
  card.style.borderColor = '#60e080';
  setTimeout(() => { card.style.borderColor = ''; }, 700);
  input.value = ''; input.focus();
  if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}

function updateHistoryLog(i) {
  const log = document.getElementById('history-' + i);
  if (log) log.innerHTML = state.players[i].history.slice(-6).reverse()
    .map(h => '<div class="history-item">üìã ' + escHtml(h) + '</div>').join('');
}

// ===== FINAL =====
function showFinalScreen() {
  showPage('page-result');
  document.getElementById('final-input-section').style.display = 'block';
  document.getElementById('results-section').style.display = 'none';
  const container = document.getElementById('final-inputs');
  container.innerHTML = '';
  state.players.forEach((p, i) => {
    const row = document.createElement('div');
    row.className = 'final-row';
    row.innerHTML = `<label>${escHtml(p.name)}</label>
      <input type="number" id="final-${i}" value="${p.currentChips}" min="0" inputmode="numeric" oninput="updateChipsSum()">`;
    container.appendChild(row);
  });
  updateChipsSum();
}

function updateChipsSum() {
  const total = state.players.reduce((s, _, i) => {
    const v = parseInt(document.getElementById('final-' + i)?.value) || 0;
    return s + v;
  }, 0);
  const invested = state.players.reduce((s, p) => s + p.startChips, 0);
  const diff = total - invested;
  const el = document.getElementById('chips-sum-live');
  if (diff === 0) {
    el.innerHTML = '‚úÖ –°—É–º–º–∞: <b style="color:#60e080">' + total + '</b> = ' + invested + ' (OK)';
  } else {
    el.innerHTML = '‚ö†Ô∏è –°—É–º–º–∞: <b style="color:#f0a040">' + total + '</b>, –Ω—É–∂–Ω–æ ' + invested + ' (—Ä–∞–∑–Ω–∏—Ü–∞: ' + (diff > 0 ? '+' : '') + diff + ')';
  }
}

function calculateResults() {
  const finals = state.players.map((p, i) => {
    const v = parseInt(document.getElementById('final-' + i).value);
    if (isNaN(v) || v < 0) { showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ —Ñ–∏—à–µ–∫ –¥–ª—è ' + p.name); throw ''; }
    return v;
  });
  state.players.forEach((p, i) => p.finalChips = finals[i]);

  const totalStart = state.players.reduce((s, p) => s + p.startChips, 0);
  const totalFinal = state.players.reduce((s, p) => s + p.finalChips, 0);
  const balanceInfo = document.getElementById('chips-balance-info');
  if (totalStart !== totalFinal) {
    balanceInfo.innerHTML = '‚ö†Ô∏è –í–ª–æ–∂–µ–Ω–æ: <b>' + totalStart + '</b>, –∏—Ç–æ–≥–æ: <b>' + totalFinal + '</b> ‚Äî —Ä–∞–∑–Ω–∏—Ü–∞ ' + (totalFinal-totalStart);
    balanceInfo.style.color = '#f0a040';
  } else {
    balanceInfo.innerHTML = '‚úÖ –ë–∞–ª–∞–Ω—Å —Å—Ö–æ–¥–∏—Ç—Å—è: ' + totalFinal + ' —Ñ–∏—à–µ–∫';
    balanceInfo.style.color = '#60e080';
  }

  // Sort by result for display
  const sorted = [...state.players].sort((a,b) => (b.finalChips-b.startChips) - (a.finalChips-a.startChips));
  const tbody = document.getElementById('result-tbody');
  tbody.innerHTML = sorted.map(p => {
    const diff = p.finalChips - p.startChips;
    const dRub = (diff/state.chipsPerRub).toFixed(2);
    const cls = diff > 0 ? 'pos' : diff < 0 ? 'neg' : 'zero';
    const sign = diff > 0 ? '+' : '';
    return `<tr><td><b>${escHtml(p.name)}</b></td><td>${p.startChips}</td><td>${p.finalChips}</td><td class="${cls}">${sign}${dRub} ‚ÇΩ</td></tr>`;
  }).join('');

  const txs = minimizeTransactions(state.players.map(p => ({ name: p.name, balance: (p.finalChips-p.startChips)/state.chipsPerRub })));
  const txList = document.getElementById('transactions-list');
  txList.innerHTML = '';
  if (!txs.length) { txList.innerHTML = '<li>üéâ –í—Å–µ –≤ —Ä–∞—Å—á—ë—Ç–µ!</li>'; }
  else txs.forEach((t, idx) => {
    const li = document.createElement('li'); li.id = 'tx-' + idx;
    li.innerHTML = `<span>üí∏ <b>${escHtml(t.from)}</b></span><span class="arrow">‚Üí</span>
      <span><b>${escHtml(t.to)}</b></span>
      <span class="amount">${t.amount.toFixed(2)} ‚ÇΩ</span>
      <button class="settle-btn" onclick="settleTx(${idx})">‚úì</button>`;
    txList.appendChild(li);
  });

  document.getElementById('final-input-section').style.display = 'none';
  document.getElementById('results-section').style.display = 'block';
  if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
}

function minimizeTransactions(balances) {
  const eps = 0.005;
  let debtors = balances.filter(b => b.balance < -eps).map(b => ({...b})).sort((a,b) => a.balance-b.balance);
  let creditors = balances.filter(b => b.balance > eps).map(b => ({...b})).sort((a,b) => b.balance-a.balance);
  const txs = []; let di=0, ci=0;
  while (di < debtors.length && ci < creditors.length) {
    const d=debtors[di], c=creditors[ci], amount=Math.min(-d.balance, c.balance);
    if (amount > eps) txs.push({ from:d.name, to:c.name, amount });
    d.balance+=amount; c.balance-=amount;
    if (Math.abs(d.balance)<eps) di++;
    if (Math.abs(c.balance)<eps) ci++;
  }
  return txs;
}

function settleTx(idx) {
  const li = document.getElementById('tx-' + idx);
  li.classList.add('settled');
  li.querySelector('.settle-btn').disabled = true;
  if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
}

// ===== SAVE =====
function saveAndNewGame() {
  const data = loadData();
  const gameRecord = {
    id: Date.now(), name: state.gameName,
    date: new Date().toISOString(), dateStr: formatDate(new Date()),
    chipsPerRub: state.chipsPerRub,
    players: state.players.map(p => ({
      name: p.name, startChips: p.startChips,
      finalChips: p.finalChips || p.currentChips,
      diff: (p.finalChips||p.currentChips) - p.startChips,
      diffRub: ((p.finalChips||p.currentChips) - p.startChips) / state.chipsPerRub
    }))
  };
  data.games.unshift(gameRecord);
  gameRecord.players.forEach(p => {
    if (!data.players[p.name]) data.players[p.name] = { name:p.name, games:0, totalDiffRub:0, wins:0, losses:0 };
    const ps = data.players[p.name];
    ps.games++; ps.totalDiffRub += p.diffRub;
    if (p.diffRub > 0.005) ps.wins++;
    else if (p.diffRub < -0.005) ps.losses++;
  });
  saveData(data);
  if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
  showAlert('‚úÖ –ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
  newGame();
}

// ===== LEADERBOARD =====
function renderLeaderboard() {
  const data = loadData();
  const players = Object.values(data.players).sort((a,b) => b.totalDiffRub - a.totalDiffRub);
  const lbDiv = document.getElementById('leaderboard-content');
  const statsDiv = document.getElementById('stats-content');
  if (!players.length) {
    lbDiv.innerHTML = '<div class="empty-state">üÉè –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–≥—Ä</div>';
    statsDiv.innerHTML = ''; return;
  }
  const medals = ['ü•á','ü•à','ü•â'];
  lbDiv.innerHTML = `<table class="leader-table">
    <thead><tr><th>#</th><th>–ò–≥—Ä–æ–∫</th><th>–ò–≥—Ä—ã</th><th>W/L</th><th>WR%</th><th>–ò—Ç–æ–≥–æ ‚ÇΩ</th></tr></thead>
    <tbody>${players.map((p,i) => {
      const cls = p.totalDiffRub > 0.005 ? 'pos' : p.totalDiffRub < -0.005 ? 'neg' : 'zero';
      const sign = p.totalDiffRub > 0 ? '+' : '';
      const wr = p.games > 0 ? Math.round(p.wins/p.games*100) : 0;
      return `<tr class="${i<3?'rank-'+(i+1):''}">
        <td>${i<3?medals[i]:(i+1)+'.'}
        </td><td><b>${escHtml(p.name)}</b></td>
        <td>${p.games}</td><td>${p.wins}/${p.losses}</td>
        <td>${wr}%</td>
        <td class="${cls}">${sign}${p.totalDiffRub.toFixed(2)} ‚ÇΩ</td></tr>`;
    }).join('')}</tbody></table>`;

  const allNames = new Set(data.games.flatMap(g => g.players.map(p => p.name)));
  statsDiv.innerHTML = `<div class="stats-grid">
    <div class="stat-card"><div class="stat-val">${data.games.length}</div><div class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div></div>
    <div class="stat-card"><div class="stat-val">${allNames.size}</div><div class="stat-label">–ò–≥—Ä–æ–∫–æ–≤</div></div>
    <div class="stat-card"><div class="stat-val" style="font-size:0.95rem;">${players.length>0?escHtml(players[0].name):'‚Äî'}</div><div class="stat-label">–õ—É—á—à–∏–π</div></div>
  </div>`;
}

// ===== HISTORY =====
function renderHistory() {
  const data = loadData();
  const div = document.getElementById('history-content');
  if (!data.games.length) { div.innerHTML = '<div class="empty-state">üìö –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>'; return; }
  div.innerHTML = data.games.map(g => {
    const sorted = [...g.players].sort((a,b) => b.diffRub - a.diffRub);
    return `<div class="history-card">
      <div class="history-card-header">
        <div><div class="history-card-title">üÉè ${escHtml(g.name)}</div>
        <div class="history-card-date">${g.dateStr}</div></div>
        <button class="delete-game-btn" onclick="deleteGame(${g.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </div>
      <table class="history-mini-table">
        <thead><tr><th>–ò–≥—Ä–æ–∫</th><th>–í–ª–æ–∂–∏–ª</th><th>–ò—Ç–æ–≥</th><th>¬±‚ÇΩ</th></tr></thead>
        <tbody>${sorted.map(p => {
          const cls = p.diffRub > 0.005 ? 'pos' : p.diffRub < -0.005 ? 'neg' : 'zero';
          const sign = p.diffRub > 0 ? '+' : '';
          return `<tr><td>${escHtml(p.name)}</td><td>${p.startChips}</td><td>${p.finalChips}</td><td class="${cls}">${sign}${p.diffRub.toFixed(2)} ‚ÇΩ</td></tr>`;
        }).join('')}</tbody>
      </table></div>`;
  }).join('');
}

function deleteGame(gameId) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∏–≥—Ä—É? –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è.')) return;
  const data = loadData();
  const game = data.games.find(g => g.id === gameId);
  if (game) {
    game.players.forEach(p => {
      const ps = data.players[p.name]; if (!ps) return;
      ps.games--; ps.totalDiffRub -= p.diffRub;
      if (p.diffRub > 0.005) ps.wins--;
      else if (p.diffRub < -0.005) ps.losses--;
      if (ps.games <= 0) delete data.players[p.name];
    });
    data.games = data.games.filter(g => g.id !== gameId);
    saveData(data);
  }
  renderHistory();
  if (document.getElementById('tab-leaderboard').style.display !== 'none') renderLeaderboard();
}

// ===== UTILS =====
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}
function goBackSetup() { showPage('page-setup'); }
function newGame() {
  showPage('page-setup');
  document.querySelectorAll('.tab-content').forEach(t => t.style.display='none');
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-setup').style.display='block';
  document.querySelectorAll('.nav-tab')[0].classList.add('active');
}
function formatDate(d) {
  return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric'}) + ' ' + d.toTimeString().slice(0,5);
}
function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function showAlert(msg) {
  if (tg && tg.showAlert) tg.showAlert(msg);
  else alert(msg);
}

// Init
addPlayerInput(''); addPlayerInput(''); addPlayerInput('');
</script>
</body>
</html>
